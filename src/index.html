<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>我的生活</title>
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
  <link rel="stylesheet" href="//g.alicdn.com/msui/sm/0.6.2/css/sm-extend.min.css">
</head>
<body>
<div class="page-group">
  <div class="page page-current">
    <div class="content">
      <div style="background-color: brown;height: 8rem;"></div>
      <div align="center" style="padding: .7rem 0 .7rem 0; height: 6.5rem;">
        <div style="width: 4.5rem; height: 4.5rem; border-radius: 50%; border: .2rem solid #fff; overflow: hidden;">
          <img src="img/WX.png" width="100" height="100" id="uAvatar" alt="uAvatar" />
        </div>
        <div id="uNickname">&nbsp;</div>
      </div>
      <div class="list-block" style="margin-top: 0;">
        <form id="uForm">
          <ul>
          <!-- Text inputs -->
          <li>
            <div class="item-content">
              <div class="item-media"><i class="icon icon-form-name"></i></div>
              <div class="item-inner">
                <div class="item-title label">姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名</div>
                <div class="item-input">
                  <input type="text" name="username" placeholder="请输入你的姓名">
                </div>
              </div>
            </div>
          </li>
          <!-- Date -->
          <li>
            <div class="item-content">
              <div class="item-media"><i class="icon icon-form-calendar"></i></div>
              <div class="item-inner">
                <div class="item-title label">入伍时间</div>
                <div class="item-input">
                  <input type="date" name="join_time" placeholder="请选择您的入伍时间" value="2014-04-30">
                </div>
              </div>
            </div>
          </li>
          <li class="align-top">
            <div class="item-content">
              <div class="item-media"><i class="icon icon-form-comment"></i></div>
              <div class="item-inner">
                <div class="item-title label">职&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;级</div>
                <div class="item-input">
                  <input type="text" name="rank" placeholder="请选择您的入伍时间"/>
                </div>
              </div>
            </div>
          </li>
          <li class="align-top">
            <div class="item-content">
              <div class="item-media"><i class="icon icon-form-comment"></i></div>
              <div class="item-inner">
                <div class="item-title label">兵&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;种</div>
                <div class="item-input">
                  <input type="text" name="type" placeholder="请选择您的兵种"/>
                </div>
              </div>
            </div>
          </li>
        </ul>
        </form>
      </div>
      <div class="content-block">
        <div class="row">
          <div class="col-100">
            <a class="button button-big button-fill button-danger" id="btn-send">发&nbsp;&nbsp;&nbsp;&nbsp;起</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type='text/javascript' src='//g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
<script type='text/javascript' src='//g.alicdn.com/msui/sm/0.6.2/js/sm-extend.min.js' charset='utf-8'></script>
<script>
  const rank = ['义务兵', '士官', '军官'];
  const arm = ['陆军', '空军', '海军', '武警', '特种兵'];

  /**
   * 查找key
   * @param mode 类别
   * @param value 名称
   * @return int index
   */
  const findKey = (mode, value) => {
    let list = mode == 'rank' ? rank : arm;
    let _index = 0;
    for(let i = 0; i < list.length; i++){
       if(rank[i] == value){
         _index = i + 1;
         break;
       }
    }
    return _index;
  }

  /**
   * 创建Picker
   * @param title 标题
   * @param mod  类别
   * @param okTitle OK键名称
   * @returns {{toolbarTemplate: string, cols: {textAlign: string, values: string[]}[]}}
   * @constructor
   */
  const CreatePicker = (title = '标题', mod = 'rank', okTitle = '确定') => {
     const picker = {toolbarTemplate: '', cols: [{textAlign: 'center', values: [...rank]}]};
     picker.toolbarTemplate =
       `<header class="bar bar-nav">
         <button class="button button-link pull-right close-picker">${okTitle}</button>
         <h1 class="title">${title}</h1>
       </header>`;

     if(mod != 'rank'){
       picker.cols[0].values = [...arm];
     }
     return picker;
  }

  $("input[name='rank']").picker(CreatePicker('请选择你的职级'));
  $("input[name='type']").picker(CreatePicker('请选择你的兵种', 'arm'));

  //API 地址
  const soldierUrl = 'http://www.szsjunshi.com/soldier';

  //获取链接参数
  var params = (() => {
    var query = location.search.substr(1)
    query = query.split('&')
    var params = {}
    for (let i = 0; i < query.length; i++) {
      let q = query[i].split('=')
      if (q.length === 2) {
        params[q[0]] = q[1]
      }
    }
    return params;
  })();

  /**
   * 异步请求
   * @param url
   * @param headers
   * @returns {IterableIterator<*>}
   */
  function* gen(url, headers = {}) {
    return yield fetch(url, headers);
  }

  //用户信息
  const User = {};
  User.phone = '13800138000';
  User.img_url = [];

  //是否已授权
  if(!params.token){
    location.href = soldierUrl + '/Wechat/Login.html?back_url=http://www.szsjunshi.com:8080';
  }else{
    //首次登录鉴权后获取用户信息
    var g = gen(soldierUrl + '/Wechat/getUserInfo?token=' + params.token);
    var result = g.next();

    result.value.then(function(data){
      data.json().then(value => {
        //设置头像和昵称
        $('#uAvatar').attr('src', value.data.headimgurl);
        $('#uNickname').text(value.data.nickname);

        User.token = params.token;
        User.user_id = value.data.user_id;
      }, error => {
        console.log(error)
      });
    }).then(function(data){
      g.next(data);
    });
  }

  //发起按钮事件
  $('#btn-send').on('click', function () {
    var data = $('#uForm').serializeArray();

    //设置用户信息
    for(let item of data){
      if(item.name == 'rank' || item.name == 'type'){
        User[item.name] = findKey(item.name, item.value);
      }else{
        User[item.name] = item.value;
      }
    }

    //写入数据库
    var g = gen(soldierUrl +  '/saveData', {
      body: JSON.stringify(User),
      method: 'POST'
    });

    var res = g.next();
    res.value.then(item => {
      item.json().then(val => {
        if(!val.code){
           $.toast(val.msg);
        }else{
           alert('ok');
        }
      }, err => {
        console.log(err);
      });
    }).then(item => {
      g.next(item)
    });
  });
</script>
</body>
</html>
